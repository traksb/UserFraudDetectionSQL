-- The `user_submission_data` CTE retrieves a list of user submissions 
-- and related data, such as IP addresses and mobile carriers.
WITH user_submission_data AS
(
    SELECT
        s.id AS submission_id,
        u.id AS user_id,
        s.ip_country AS submission_ip_country,
        u.ip_country AS user_ip_country,
        u.phone_number_country_code AS user_prefix,
        l.country_code AS location_name,
        s.mobile_carrier_id AS submission_carrier,
        u.mobile_carrier_id AS user_carrier,
        s.completed_at AS completed_at,
        -- Determining the submission's carrier country
        CASE
            WHEN s.mobile_carrier_id = '' THEN l.country_code
            ELSE 
                CASE
                    when s.mobile_carrier_id::bigint in (42402,42403,43002,43102) then 'AE'
                    when s.mobile_carrier_id::bigint in (722010,722020,722040,722070,722310,722320,722330,722340,722341,722350) then 'AR'
                    when s.mobile_carrier_id::bigint in (23200,23201,23202,23203,23204,23205,23206,23207,23208,23209,23210,23211,23212,23214,23215,23216) then 'AT'
                    when s.mobile_carrier_id::bigint in (50501,50502,50503,50504,50505,50506,50507,50508,50509,50511,50512,50513,50514,50516,50519,50524,50526,50532,50538,50571,50572,50588,50590,50599) then 'AU'
                    when s.mobile_carrier_id::bigint in (20601,20602,20603,20605,20606,20607,20610,20615,20620,20640) then 'BE'
                    when s.mobile_carrier_id::bigint in (72400,72401,72402,72403,72404,72405,72406,72407,72408,72410,72411,72412,72415,72416,72418,72419,72423,72424,72430,72431,72432,72433,72434,72435,72436,72437,72438,72439,72454,72499) then 'BR'
                    when s.mobile_carrier_id::bigint in (302220,302221,302222,302250,302270,302290,302320,302340,302350,302360,302370,302380,302390,302480,302490,302500,302510,302520,302530,302560,302570,302590,302610,302620,302630,302640,302651,302652,302653,302654,302655,302656,302657,302660,302670,302680,302690,302701,302702,302703,302710,302720,302730,302740,302750,302760,302770,302780,302790,302860,302880,302940,302990) then 'CA'
                    when s.mobile_carrier_id::bigint in (61202,61203,61204,61205,61206,61207,61201) then 'CI'
                    when s.mobile_carrier_id::bigint in (73000,73001,73002,73003,73004,73005,73006,73007,73008,73009,73010,73011,73012,73013,73014,73015) then 'CL'
                    when s.mobile_carrier_id::bigint in (46000,46002,46007,46004,46003,46005,46001,46006,46011) then 'CN'
                    when s.mobile_carrier_id::bigint in (26201,26202,26203,26204,26205,26206,26207,26208,26209,26210,26211,26212,26213,26214,26216,26217,26220,26243,26277) then 'DE'
                    when s.mobile_carrier_id::bigint in (60301,60302,60303) then 'DZ'
                    when s.mobile_carrier_id::bigint in (74000,74001,74002) then 'EC'
                    when s.mobile_carrier_id::bigint in (21401,21403,21404,21405,21406,21407,21408,21409,21410,21411,21412,21413,21414,21415,21416,21417,21418,21419,21420,21421,21422,21423,21424,21425,21426,21427,21428,21429,21430,21431,21432) then 'ES'
                    when s.mobile_carrier_id::bigint in (20800,20801,20802,20803,20804,20805,20806,20807,20809,20810,20811,20813,20814,20815,20816,20820,20821,20822,20823,20824,20825,20826,20827,20828,20829,20831,20888,20889,20891,20892) then 'FR'
                    when s.mobile_carrier_id::bigint in (23400,23401,23402,23403,23404,23405,23406,23407,23408,23409,23410,23411,23412,23413,23414,23415,23416,23417,23418,23419,23420,23421,23422,23423,23424,23425,23426,23427,23428,23429,23430,23431,23432,23433,23434,23435,23436,23437,23438,23439,23450,23451,23452,23453,23454,23455,23456,23458,23475,23476,23477,23478,23486,23494,23499,23500,23501,23502,23503,23577,23591,23592,23594,23595) then 'GB'
                    when s.mobile_carrier_id::bigint in (70401,70402,70403) then 'GT'
                    when s.mobile_carrier_id::bigint in (21901,21902,21910) then 'HR'
                    when s.mobile_carrier_id::bigint in (51000,51001,51003,51007,51008,51009,51010,51011,51020,51021,51027,51028,51089,51099) then 'ID'
                    when s.mobile_carrier_id::bigint in (27201,27202,27203,27204,27205,27207,27209,27211,27213) then 'IE'
                    when s.mobile_carrier_id::bigint in (42501,42502,42503,42504,42506,42507,42508,42511,42512,42513,42514,42515,42516,42517,42518,42519,42520,42521,42523,42524,42525,42577) then 'IL'
                    when s.mobile_carrier_id::bigint in (40400,40401,40402,40403,40404,40405,40406,40407,40409,40410,40411,40412,40413,40414,40415,40416,40417,40418,40419,40420,40421,40422,40423,40424,40425,40427,40428,40429,40430,40431,40433,40434,40435,40436,40437,40438,40440,40441,40442,40443,40444,40445,40446,40448,40449,40450,40451,40452,40453,40454,40455,40456,40457,40458,40459,40460,40461,40462,40463,40464,40465,40466,40467,40468,40469,40470,40471,40472,40473,40474,40475,40476,40477,40478,40479,40480,40481,404818,40482,40483,40484,40485,40486,40487,40488,40489,40490,40491,40492,404927,40493,40494,40495,40496,40497,40498,40499,405000,405005,405006,405007,405009,405010,405011,405012,405013,405014,405018,405020,405021,405022,40501,405025,405027,405029,405030,405031,405032,405033,405034,405035,405036,405037,405038,405039,405040,405041,405042,405043,405044,405045,405046,405047,40508,40512,40509,40515,40517,40519,40523,40524,40528,40551,40552,40553,40554,40555,40556,40566,40567,40568,40570,40571,40572,40573,40574,405750,405751,405752,405753,405754,405755,405756,40576,40577,405799,405800,405801,405802,405803,405804,405805,405806,405807,405808,405809,40581,40582,40583,40584,40585,40586,405810,405811,405812,405813,405814,405815,405816,405817,405818,405819,405820,405821,405822,405823,405824,405825,405826,405827,405828,405829,405830,405831,405832,405833,405834,405835,405836,405837,405838,405839,405840,405841,405842,405843,405844,405845,405846,405847,405848,405849,405850,405851,405852,405853,405854,405855,405856,405857,405858,405859,405860,405861,405862,405863,405864,405865,405866,405867,405868,405869,405870,405871,405872,405873,405874,405875,405876,405877,405878,405879,405880,405881,405882,405883,405884,405885,405886,405887,405888,405889,405890,405891,405892,405893,405894,405895,405896,405897,405898,405899,405900,405901,405902,405903,405904,405905,405906,405907,405908,405909,405910,405911,405912,405913,405914,405915,405916,405917,405918,405919,405920,405921,405922,405923,405924,405925,405926,405927,405928,405929,405930,405931) then 'IN'
                    when s.mobile_carrier_id::bigint in (22201,22202,22204,22205,22206,22207,22210,22230,22233,22234,22235,22243,22244,22248,22277,22288,22298,22299) then 'IT'
                    when s.mobile_carrier_id::bigint in (33400,33400,334001,33401,334010,33402,334020,33403,334030,33404,334040,334050,334060,344066,334070,334080,334090,33450) then 'MX'
                    when s.mobile_carrier_id::bigint in (50201,50210,50211,50212,50213,50214,502150,502151,502152,502153,502154,502155,50216,50217,50218,50219,50220) then 'MY'
                    when s.mobile_carrier_id::bigint in (62101,62120,62125,62130,62140,62150,62160,62196,62199,621996,621997,621998) then 'NG'
                    when s.mobile_carrier_id::bigint in (20401,20402,20403,20404,20405,20406,20407,20408,20409,20410,20412,20413,20414,20415,20416,20417,20418,20419,20420,20421,20422,20423,20424,20425,20426,20427,20428,20429,20460,20461,20464,20465,20466,20467,20468,20469,20498) then 'NL'
                    when s.mobile_carrier_id::bigint in (51500,51501,51502,51503,51505,51511,51518,51588) then 'PH'
                    when s.mobile_carrier_id::bigint in (26001,26002,26003,26004,26005,26006,26007,26008,26009,26010,26011,26012,26013,26014,26015,26016,26017,26018,26019,26020,26021,26022,26023,26024,26025,26026,26027,26028,26029,26030,26031,26032,26033,26034,26035,26036,26038,26098) then 'PL'
                    when s.mobile_carrier_id::bigint in (26801,26803,26804,26806,26807,26821) then 'PT'
                    when s.mobile_carrier_id::bigint in (22601,22602,22603,22604,22605,22606,22610,22611) then 'RO'
                    when s.mobile_carrier_id::bigint in (25001,25002,25003,25004,25005,25006,25007,25008,25009,25010,25011,25012,25013,25014,25015,25016,25017,25019,25020,25020,25020,25022,25023,25028,25035,25038,25039,25044,25050,25092,25093,25098,25099) then 'RU'
                    when s.mobile_carrier_id::bigint in (42001,42002,42003,42004,42007) then 'SA'
                    when s.mobile_carrier_id::bigint in (24000,24001,24002,24003,24004,24005,24006,24007,24008,24009,24010,24011,24012,24013,24014,24015,24016,24017,24018,24019,24020,24021,24022,24023,24024,24024,24025,24026,24027,24028,24029,24030,24032,24033,24034,24035,24036,24037,24038,24039,24040,24041,24042,24043,24044,24045,24065,24066,24067,24068,24069) then 'SE'
                    when s.mobile_carrier_id::bigint in (52501,52502,52503,52505,52506,52507,52512) then 'SG'
                    when s.mobile_carrier_id::bigint in (52000,52001,52002,52003,52004,52005,52015,52018,52020,52023,52025,52047,52099) then 'TH'
                    when s.mobile_carrier_id::bigint in (28601,28602,28603,28604) then 'TR'
                    when s.mobile_carrier_id::bigint in (25501,25502,25503,25504,25505,25506,25507,25521,25523,25539,25550,25567,25568) then 'UA'
                    when s.mobile_carrier_id::bigint in (45201,45202,45203,45204,45205,45206,45207,45208) then 'VN'
                    when s.mobile_carrier_id::bigint in (65501,65502,65506,65507,65510,65511,65512,65516,65519,65521,65530,65531,65532,65533) then 'ZA'
                    when s.mobile_carrier_id::bigint in (310003,310004,310010,310011,310012,310013,310016,310017,310020,310030,310034,310035,310040,310050,310060,310070,310080,310090,310100,310110,310120,310130,31014,310140,31015,310150,310160,310170,310180,310190,310200,310210,310220,311230,310230,310240,310250,310260,310270,310280,310290,310300,310310,310320,310330,310340,310350,310360,310370,31038,310380,310390,310400,310410,310420,310430,310440,310450,31046,310460,310470,310480,310490,310500,310510,310520,310530,310540,310550,310560,310570,310580,310590,31060,310600,310610,310620,310630,310640,310650,310660,310670,310680,310690,310700,310710,310720,310730,310740,310740,310740,310750,310760,310770,310780,310790,310800,310810,310820,310830,310840,310850,310860,310870,310880,310890,310900,310910,310920,310930,310940,310950,310960,310970,310980,310990,311000,311010,311020,311030,311030,311030,311040,311050,311060,311070,311080,311090,311100,311110,311120,311130,311140,311150,311160,311170,311180,311190,311200,311210,311220,311230,311240,311240,311250,311260,311270,311271,311272,311273,311274,311275,311276,311277,311278,311279,311280,311281,311282,311283,311284,311285,311286,311287,311288,311289,311290,311300,311310,311311,311320,311330,311340,311350,311360,311370,311380,311390,311410,311420,311430,311440,311450,311460,311470,311480,311481,311482,311483,311484,311485,311486,311487,311488,311489,311490,311500,311510,311520,311530,311540,311550,311560,311570,311580,311590,311600,311610,311620,311630,311640,311650,311660,311670,311680,311690,311700,311710,311720,311730,311740,311750,311760,311770,311800,311810,311820,311830,311840,311850,311860,311870,311880,311890,311900,311910,311920,311940,311950,311960,311970,311980,311990,312010,312020,312030,312040,312050,312060,312070,312080,312090,312100,312110,312120,312130,312140,312150,312160,312170,312180,312190,312200,312220,312230,312270,312280,312290,312380,313100,316010,316011) then 'US'
                END
        END AS submission_carrier_country,
        -- Determining the user's carrier country
        CASE
            WHEN u.mobile_carrier_id = '' THEN l.country_code
            ELSE 
                CASE
                     when s.mobile_carrier_id::bigint in (42402,42403,43002,43102) then 'AE'
                    when s.mobile_carrier_id::bigint in (722010,722020,722040,722070,722310,722320,722330,722340,722341,722350) then 'AR'
                    when s.mobile_carrier_id::bigint in (23200,23201,23202,23203,23204,23205,23206,23207,23208,23209,23210,23211,23212,23214,23215,23216) then 'AT'
                    when s.mobile_carrier_id::bigint in (50501,50502,50503,50504,50505,50506,50507,50508,50509,50511,50512,50513,50514,50516,50519,50524,50526,50532,50538,50571,50572,50588,50590,50599) then 'AU'
                    when s.mobile_carrier_id::bigint in (20601,20602,20603,20605,20606,20607,20610,20615,20620,20640) then 'BE'
                    when s.mobile_carrier_id::bigint in (72400,72401,72402,72403,72404,72405,72406,72407,72408,72410,72411,72412,72415,72416,72418,72419,72423,72424,72430,72431,72432,72433,72434,72435,72436,72437,72438,72439,72454,72499) then 'BR'
                    when s.mobile_carrier_id::bigint in (302220,302221,302222,302250,302270,302290,302320,302340,302350,302360,302370,302380,302390,302480,302490,302500,302510,302520,302530,302560,302570,302590,302610,302620,302630,302640,302651,302652,302653,302654,302655,302656,302657,302660,302670,302680,302690,302701,302702,302703,302710,302720,302730,302740,302750,302760,302770,302780,302790,302860,302880,302940,302990) then 'CA'
                    when s.mobile_carrier_id::bigint in (61202,61203,61204,61205,61206,61207,61201) then 'CI'
                    when s.mobile_carrier_id::bigint in (73000,73001,73002,73003,73004,73005,73006,73007,73008,73009,73010,73011,73012,73013,73014,73015) then 'CL'
                    when s.mobile_carrier_id::bigint in (46000,46002,46007,46004,46003,46005,46001,46006,46011) then 'CN'
                    when s.mobile_carrier_id::bigint in (26201,26202,26203,26204,26205,26206,26207,26208,26209,26210,26211,26212,26213,26214,26216,26217,26220,26243,26277) then 'DE'
                    when s.mobile_carrier_id::bigint in (60301,60302,60303) then 'DZ'
                    when s.mobile_carrier_id::bigint in (74000,74001,74002) then 'EC'
                    when s.mobile_carrier_id::bigint in (21401,21403,21404,21405,21406,21407,21408,21409,21410,21411,21412,21413,21414,21415,21416,21417,21418,21419,21420,21421,21422,21423,21424,21425,21426,21427,21428,21429,21430,21431,21432) then 'ES'
                    when s.mobile_carrier_id::bigint in (20800,20801,20802,20803,20804,20805,20806,20807,20809,20810,20811,20813,20814,20815,20816,20820,20821,20822,20823,20824,20825,20826,20827,20828,20829,20831,20888,20889,20891,20892) then 'FR'
                    when s.mobile_carrier_id::bigint in (23400,23401,23402,23403,23404,23405,23406,23407,23408,23409,23410,23411,23412,23413,23414,23415,23416,23417,23418,23419,23420,23421,23422,23423,23424,23425,23426,23427,23428,23429,23430,23431,23432,23433,23434,23435,23436,23437,23438,23439,23450,23451,23452,23453,23454,23455,23456,23458,23475,23476,23477,23478,23486,23494,23499,23500,23501,23502,23503,23577,23591,23592,23594,23595) then 'GB'
                    when s.mobile_carrier_id::bigint in (70401,70402,70403) then 'GT'
                    when s.mobile_carrier_id::bigint in (21901,21902,21910) then 'HR'
                    when s.mobile_carrier_id::bigint in (51000,51001,51003,51007,51008,51009,51010,51011,51020,51021,51027,51028,51089,51099) then 'ID'
                    when s.mobile_carrier_id::bigint in (27201,27202,27203,27204,27205,27207,27209,27211,27213) then 'IE'
                    when s.mobile_carrier_id::bigint in (42501,42502,42503,42504,42506,42507,42508,42511,42512,42513,42514,42515,42516,42517,42518,42519,42520,42521,42523,42524,42525,42577) then 'IL'
                    when s.mobile_carrier_id::bigint in (40400,40401,40402,40403,40404,40405,40406,40407,40409,40410,40411,40412,40413,40414,40415,40416,40417,40418,40419,40420,40421,40422,40423,40424,40425,40427,40428,40429,40430,40431,40433,40434,40435,40436,40437,40438,40440,40441,40442,40443,40444,40445,40446,40448,40449,40450,40451,40452,40453,40454,40455,40456,40457,40458,40459,40460,40461,40462,40463,40464,40465,40466,40467,40468,40469,40470,40471,40472,40473,40474,40475,40476,40477,40478,40479,40480,40481,404818,40482,40483,40484,40485,40486,40487,40488,40489,40490,40491,40492,404927,40493,40494,40495,40496,40497,40498,40499,405000,405005,405006,405007,405009,405010,405011,405012,405013,405014,405018,405020,405021,405022,40501,405025,405027,405029,405030,405031,405032,405033,405034,405035,405036,405037,405038,405039,405040,405041,405042,405043,405044,405045,405046,405047,40508,40512,40509,40515,40517,40519,40523,40524,40528,40551,40552,40553,40554,40555,40556,40566,40567,40568,40570,40571,40572,40573,40574,405750,405751,405752,405753,405754,405755,405756,40576,40577,405799,405800,405801,405802,405803,405804,405805,405806,405807,405808,405809,40581,40582,40583,40584,40585,40586,405810,405811,405812,405813,405814,405815,405816,405817,405818,405819,405820,405821,405822,405823,405824,405825,405826,405827,405828,405829,405830,405831,405832,405833,405834,405835,405836,405837,405838,405839,405840,405841,405842,405843,405844,405845,405846,405847,405848,405849,405850,405851,405852,405853,405854,405855,405856,405857,405858,405859,405860,405861,405862,405863,405864,405865,405866,405867,405868,405869,405870,405871,405872,405873,405874,405875,405876,405877,405878,405879,405880,405881,405882,405883,405884,405885,405886,405887,405888,405889,405890,405891,405892,405893,405894,405895,405896,405897,405898,405899,405900,405901,405902,405903,405904,405905,405906,405907,405908,405909,405910,405911,405912,405913,405914,405915,405916,405917,405918,405919,405920,405921,405922,405923,405924,405925,405926,405927,405928,405929,405930,405931) then 'IN'
                    when s.mobile_carrier_id::bigint in (22201,22202,22204,22205,22206,22207,22210,22230,22233,22234,22235,22243,22244,22248,22277,22288,22298,22299) then 'IT'
                    when s.mobile_carrier_id::bigint in (33400,33400,334001,33401,334010,33402,334020,33403,334030,33404,334040,334050,334060,344066,334070,334080,334090,33450) then 'MX'
                    when s.mobile_carrier_id::bigint in (50201,50210,50211,50212,50213,50214,502150,502151,502152,502153,502154,502155,50216,50217,50218,50219,50220) then 'MY'
                    when s.mobile_carrier_id::bigint in (62101,62120,62125,62130,62140,62150,62160,62196,62199,621996,621997,621998) then 'NG'
                    when s.mobile_carrier_id::bigint in (20401,20402,20403,20404,20405,20406,20407,20408,20409,20410,20412,20413,20414,20415,20416,20417,20418,20419,20420,20421,20422,20423,20424,20425,20426,20427,20428,20429,20460,20461,20464,20465,20466,20467,20468,20469,20498) then 'NL'
                    when s.mobile_carrier_id::bigint in (51500,51501,51502,51503,51505,51511,51518,51588) then 'PH'
                    when s.mobile_carrier_id::bigint in (26001,26002,26003,26004,26005,26006,26007,26008,26009,26010,26011,26012,26013,26014,26015,26016,26017,26018,26019,26020,26021,26022,26023,26024,26025,26026,26027,26028,26029,26030,26031,26032,26033,26034,26035,26036,26038,26098) then 'PL'
                    when s.mobile_carrier_id::bigint in (26801,26803,26804,26806,26807,26821) then 'PT'
                    when s.mobile_carrier_id::bigint in (22601,22602,22603,22604,22605,22606,22610,22611) then 'RO'
                    when s.mobile_carrier_id::bigint in (25001,25002,25003,25004,25005,25006,25007,25008,25009,25010,25011,25012,25013,25014,25015,25016,25017,25019,25020,25020,25020,25022,25023,25028,25035,25038,25039,25044,25050,25092,25093,25098,25099) then 'RU'
                    when s.mobile_carrier_id::bigint in (42001,42002,42003,42004,42007) then 'SA'
                    when s.mobile_carrier_id::bigint in (24000,24001,24002,24003,24004,24005,24006,24007,24008,24009,24010,24011,24012,24013,24014,24015,24016,24017,24018,24019,24020,24021,24022,24023,24024,24024,24025,24026,24027,24028,24029,24030,24032,24033,24034,24035,24036,24037,24038,24039,24040,24041,24042,24043,24044,24045,24065,24066,24067,24068,24069) then 'SE'
                    when s.mobile_carrier_id::bigint in (52501,52502,52503,52505,52506,52507,52512) then 'SG'
                    when s.mobile_carrier_id::bigint in (52000,52001,52002,52003,52004,52005,52015,52018,52020,52023,52025,52047,52099) then 'TH'
                    when s.mobile_carrier_id::bigint in (28601,28602,28603,28604) then 'TR'
                    when s.mobile_carrier_id::bigint in (25501,25502,25503,25504,25505,25506,25507,25521,25523,25539,25550,25567,25568) then 'UA'
                    when s.mobile_carrier_id::bigint in (45201,45202,45203,45204,45205,45206,45207,45208) then 'VN'
                    when s.mobile_carrier_id::bigint in (65501,65502,65506,65507,65510,65511,65512,65516,65519,65521,65530,65531,65532,65533) then 'ZA'
                    when s.mobile_carrier_id::bigint in (310003,310004,310010,310011,310012,310013,310016,310017,310020,310030,310034,310035,310040,310050,310060,310070,310080,310090,310100,310110,310120,310130,31014,310140,31015,310150,310160,310170,310180,310190,310200,310210,310220,311230,310230,310240,310250,310260,310270,310280,310290,310300,310310,310320,310330,310340,310350,310360,310370,31038,310380,310390,310400,310410,310420,310430,310440,310450,31046,310460,310470,310480,310490,310500,310510,310520,310530,310540,310550,310560,310570,310580,310590,31060,310600,310610,310620,310630,310640,310650,310660,310670,310680,310690,310700,310710,310720,310730,310740,310740,310740,310750,310760,310770,310780,310790,310800,310810,310820,310830,310840,310850,310860,310870,310880,310890,310900,310910,310920,310930,310940,310950,310960,310970,310980,310990,311000,311010,311020,311030,311030,311030,311040,311050,311060,311070,311080,311090,311100,311110,311120,311130,311140,311150,311160,311170,311180,311190,311200,311210,311220,311230,311240,311240,311250,311260,311270,311271,311272,311273,311274,311275,311276,311277,311278,311279,311280,311281,311282,311283,311284,311285,311286,311287,311288,311289,311290,311300,311310,311311,311320,311330,311340,311350,311360,311370,311380,311390,311410,311420,311430,311440,311450,311460,311470,311480,311481,311482,311483,311484,311485,311486,311487,311488,311489,311490,311500,311510,311520,311530,311540,311550,311560,311570,311580,311590,311600,311610,311620,311630,311640,311650,311660,311670,311680,311690,311700,311710,311720,311730,311740,311750,311760,311770,311800,311810,311820,311830,311840,311850,311860,311870,311880,311890,311900,311910,311920,311940,311950,311960,311970,311980,311990,312010,312020,312030,312040,312050,312060,312070,312080,312090,312100,312110,312120,312130,312140,312150,312160,312170,312180,312190,312200,312220,312230,312270,312280,312290,312380,313100,316010,316011) then 'US'
                END
        END AS user_carrier_country,
        -- Setting the action based on discrepancies
        CASE 
            WHEN 
                (l.country_code != s.ip_country OR l.country_code != u.ip_country) AND l.country_code NOT IN ('CN', 'RU') THEN 'wrong ip'
            WHEN
                (l.country_code != u.phone_number_country_code)
            THEN 'wrong prefix' ELSE 'pass'
        END AS action
    FROM submissions s
    JOIN users u ON s.user_id = u.id
    JOIN locations l ON l.id = s.location_id
    JOIN projects p ON p.id = s.project_id
    WHERE s.completed_at BETWEEN TIMESTAMP '{{ date.start }} 00:00:00' AND TIMESTAMP '{{ date.end }} 23:59:59'
    AND p.code NOT LIKE ('%CGPT%')
),
-- The `carrier_check_data` CTE verifies the mobile carrier data against the location data
carrier_check_data AS
(
    SELECT
        s.id AS submission_id,
        l.country_code AS location_name,
        s.completed_at AS submission_completed_at,
        usd.action AS action,
        usd.submission_carrier_country AS submission_carrier_country,
        usd.user_carrier_country AS user_carrier_country,
        -- Checking the carrier's country against the location country
        CASE
            WHEN
                (l.country_code != usd.user_carrier_country OR l.country_code != usd.submission_carrier_country)
            THEN 'wrong carrier id' ELSE 'pass'
        END AS carrier_check
    FROM user_submission_data usd
    JOIN submissions s ON s.id = usd.submission_id 
    JOIN users u ON s.user_id = u.id
    JOIN locations l ON s.location_id = l.id
    JOIN projects p ON s.project_id = p.id
    WHERE s.completed_at BETWEEN TIMESTAMP '{{ date.start }} 00:00:00' AND TIMESTAMP '{{ date.end }} 23:59:59'
    AND p.code NOT LIKE ('%CGPT%')
)

-- Final query to join the two CTEs and extract necessary fields 
-- for the detection of potentially fraudulent user activities.
SELECT
    p.log_type,
    p.code AS project_code,
    s.project_id,
    usd.action,
    ccd.carrier_check,
    s.id AS submission_id,
    u.id AS user_id,
    s.completed_at AS completed_at,
    s.status AS submission_status,
    s.payout_value AS payout_value,
    s.payout_currency AS payout_currency,
    p.auto_approve_submissions AS auto_approve,
    CASE WHEN u.deleted_at IS NOT NULL THEN 'true' ELSE 'false' END AS deleted_at,
    CASE WHEN u.blocked_at IS NOT NULL THEN 'true' ELSE 'false' END AS blocked_at,
    l.country_code AS location_name,
    usd.submission_ip_country AS submission_ip,
    usd.user_ip_country AS user_ip_country,
    usd.submission_carrier_country AS submission_carrier_country,
    usd.user_carrier_country AS user_carrier_country,
    u.phone_number_country_code AS prefix
FROM carrier_check_data ccd
JOIN user_submission_data usd ON usd.submission_id = ccd.submission_id
JOIN submissions s ON s.id = usd.submission_id
JOIN projects p ON s.project_id = p.id
JOIN users u ON u.id = s.user_id
JOIN locations l ON s.location_id = l.id
WHERE s.status IN ('completed','unpaid','final')
AND (usd.action IN ('wrong ip','wrong prefix') OR ccd.carrier_check = 'wrong carrier id')
AND s.completed_at BETWEEN TIMESTAMP '{{ date.start }} 00:00:00' AND TIMESTAMP '{{ date.end }} 23:59:59'
AND p.code NOT LIKE ('%CGPT%')
;